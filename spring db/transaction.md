# 트랜잭션

- 원자성
- 일관성
- ## 격리성 : 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다.
- 지속성

- 격리성을 완벽히 보장하려면 트랜잭션을 거의 순서대로 실행해야 한다 ( ANSI 표준은 격리수준을 4단계로 나우어 정의했다.)

    - 트랜잭션 격리 수준
    1. 커밋되지 않은 읽기
    2. 커밋된 읽기
    3. 반복 가능한 읽기
    4. 직렬화 기능


## DB 연결 구조와 DB 세션

1. 사용자마다 DB에 연결을 요청해서 커넥션을 얻고 DB와 맺게 된다 
2. 이때 DB 내부에 세션이라는 것을 만들고 앞으로 해당 커넥션을 통한 모든 요청은 이 세션으로 실행
3. 세션은 트랜잭션을 시작하고 커밋 또는 롤백으로 트랜잭션을 종료한다
4. 커넥션풀과 세션은 1:1로 매칭된다


## 트랜잭션 개념

 - 본인의 세션안에서는 커밋하지 않은 데이터가 보이지만 다른 세션은 보이지 않는다 ( 데이터 정합성 문제 때문에 / 커밋되지 않은 읽기 옵션을 주면 보이긴 함)

 ## 자동커밋 수동커밋


 - 트랜잭션 걸려면 수동커밋을 해야한다 ( sql마다 커밋이 나가기 때문에 수동으로 바꿔야함)


## DB락

세션 1이 데이터를 수정하는 동안 세션2가 데이터에 변화를 주면 원자성이 깨진다

- 변경 : 해당 **로우**의 락을 획득해야 데이터를 변경 할 수 있다 ( 세션2가 중간에 끼어들면 락이 돌아올때까지 대기한다 ) ( SET LOCK_TIMEOUT  {MS} )

- 조회 : 조회할때는 기본적으로 락을 획득하지 않고 조회 한다. 하지만 데이터를 조회 할 때도 락을 획득 하고 싶으면 select for update 구문을 사용하면 된다.

## 트랜잭션 적용

- 트랜잭션을 사용하는 동안 같은 커넥션을 유지해야한다.


## 트랜잭션 문제 해결

- 서비스 계층은 특정 기술에 종속적이지 않게 최대한 순수 자바코드로 작성해야한다

- service부분의 SQLException은 jdbc에 종속적이기 때문에 가급적 repository에서 처리해야한다( jdbc구현기술이 서비스 계층에 누수 됨)


1. repository 기술 서비스 계층에 누수 
2. 예외 누수 
3. jdbc 반복 문제

- 스프링은 이 문제들을 해결 할 수 있는 다양한 방법을 제공한다